# New BSD 3-Clause License (https://github.com/Krypton-Suite/Standard-Toolkit/blob/master/LICENSE)
# Modifications by Peter Wagner (aka Wagnerp), Simon Coghlan (aka Smurf-IV), Giduac, tobitege et al. 2026 - 2026. All rights reserved.
#
# Syncs alpha to alpha-backup when alpha has commits in the last 24 hours by creating
# a PR from alpha into alpha-backup. Creates alpha-backup branch if it does not exist.
# Enable auto-merge on the repo for these PRs to make the backup fully automated.
#
# KILL-SWITCH: To disable this workflow, set repository variable ALPHA_BACKUP_SYNC_DISABLED=true
# Location: Repository Settings â†’ Secrets and variables â†’ Actions â†’ Variables tab
# To re-enable: Set ALPHA_BACKUP_SYNC_DISABLED=false or delete the variable
#
# Discord: Set secret DISCORD_WEBHOOK_ALPHA_BACKUP to send notifications (optional).

name: Alpha to Alpha-Backup Sync

on:
  schedule:
    # Run at midnight UTC daily
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Alpha Backup Sync Kill Switch Check
        id: kill_switch
        run: |
          disabled="${{ vars.ALPHA_BACKUP_SYNC_DISABLED }}"
          if [ "$disabled" = "true" ]; then
            echo "::warning:: Alpha Backup Sync workflow is currently DISABLED via kill switch (ALPHA_BACKUP_SYNC_DISABLED=true)"
            echo "To re-enable: Go to Repository Settings -> Secrets and Variables -> Actions -> Variables -> Set ALPHA_BACKUP_SYNC_DISABLED to 'false'."
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          else
            echo "Alpha Backup Sync kill switch check has passed, continuing..."
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: steps.kill_switch.outputs.enabled == 'true'
        uses: actions/checkout@v6
        with:
          ref: alpha
          fetch-depth: 0

      - name: Check for changes on alpha in last 24 hours
        if: steps.kill_switch.outputs.enabled == 'true'
        id: check_changes
        run: |
          yesterday=$(date -u -d '24 hours ago' '+%Y-%m-%d %H:%M:%S')
          commit_count=$(git rev-list --count --since="$yesterday" alpha 2>/dev/null || echo "0")
          echo "Commits on alpha in last 24 hours: $commit_count"
          if [ "${commit_count:-0}" -gt 0 ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure alpha-backup exists
        if: steps.kill_switch.outputs.enabled == 'true' && steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        id: ensure_backup
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            try {
              await github.rest.repos.getBranch({ owner, repo, branch: 'alpha-backup' });
              console.log('Branch alpha-backup already exists.');
              return 'exists';
            } catch (err) {
              if (err.status !== 404) throw err;
            }
            const { data: ref } = await github.rest.git.getRef({ owner, repo, ref: 'heads/alpha' });
            await github.rest.git.createRef({
              owner,
              repo,
              ref: 'refs/heads/alpha-backup',
              sha: ref.object.sha
            });
            console.log('Created branch alpha-backup from alpha.');
            return 'created';

      - name: Create PR from alpha to alpha-backup
        if: steps.kill_switch.outputs.enabled == 'true' && steps.check_changes.outputs.has_changes == 'true'
        id: create_pr
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            let result = { pr_created: false, pr_number: '', pr_url: '' };
            const { data: compare } = await github.rest.repos.compareCommitsWithBasehead({
              owner,
              repo,
              basehead: 'alpha-backup...alpha'
            });
            if (compare.ahead_by === 0) {
              console.log('alpha-backup is already up to date with alpha; no PR needed.');
              return result;
            }
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:alpha`,
              base: 'alpha-backup'
            });
            if (prs.length > 0) {
              console.log('Open PR from alpha to alpha-backup already exists: #' + prs[0].number);
              result.pr_number = prs[0].number;
              result.pr_url = prs[0].html_url;
              return result;
            }
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: 'chore: sync alpha â†’ alpha-backup (automated)',
              head: 'alpha',
              base: 'alpha-backup',
              body: 'Automated PR: alpha has had commits in the last 24 hours. Merge to update alpha-backup.\n\n*Triggered by Alpha to Alpha-Backup Sync workflow.*'
            });
            console.log('Created PR #' + pr.number + ' from alpha to alpha-backup.');
            result.pr_created = true;
            result.pr_number = pr.number;
            result.pr_url = pr.html_url;
            return result;

      - name: Discord notification
        if: steps.kill_switch.outputs.enabled == 'true' && steps.check_changes.outputs.has_changes == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_ALPHA_BACKUP }}
          BRANCH_CREATED: ${{ steps.ensure_backup.outputs.result == 'created' }}
          PR_RESULT: ${{ steps.create_pr.outputs.result }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK_ALPHA_BACKUP not set - skipping Discord notification"
            exit 0
          fi
          pr_link=""
          if [ -n "$PR_RESULT" ]; then
            pr_url=$(echo "$PR_RESULT" | jq -r '.pr_url // empty')
            pr_number=$(echo "$PR_RESULT" | jq -r '.pr_number // empty')
            if [ -n "$pr_url" ]; then
              pr_link="\nâ€¢ [PR #$pr_number]($pr_url)"
            fi
          fi
          branch_msg="alpha-backup branch already existed"
          if [ "$BRANCH_CREATED" = "true" ]; then
            branch_msg="alpha-backup branch was created (did not exist)"
          fi
          payload=$(jq -n \
            --arg branch "$branch_msg" \
            --arg pr_link "$pr_link" \
            --arg run_url "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            '{
              embeds: [{
                title: "ðŸ“¦ Alpha â†’ Alpha-Backup Sync",
                description: ("Alpha had commits in the last 24 hours. Sync workflow ran.\n\nâ€¢ " + $branch + $pr_link + "\nâ€¢ [Workflow run](" + $run_url + ")"),
                color: 3447003,
                timestamp: (now | todate),
                footer: { text: "Alpha Backup Sync" }
              }]
            }')
          curl -sS -X POST "$DISCORD_WEBHOOK" -H "Content-Type: application/json" -d "$payload"
