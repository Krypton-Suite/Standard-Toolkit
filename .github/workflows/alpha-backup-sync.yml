# New BSD 3-Clause License (https://github.com/Krypton-Suite/Standard-Toolkit/blob/master/LICENSE)
# Modifications by Peter Wagner (aka Wagnerp), Simon Coghlan (aka Smurf-IV), Giduac, tobitege et al. 2026 - 2026. All rights reserved.
#
# Syncs alpha to alpha-backup when alpha has commits in the last 24 hours by creating
# a PR from alpha into alpha-backup. Creates alpha-backup branch if it does not exist.
# Enable auto-merge on the repo for these PRs to make the backup fully automated.
#
# KILL-SWITCH: To disable this workflow, set repository variable ALPHA_BACKUP_SYNC_DISABLED=true
# Location: Repository Settings â†’ Secrets and variables â†’ Actions â†’ Variables tab
# To re-enable: Set ALPHA_BACKUP_SYNC_DISABLED=false or delete the variable
#
# Discord: Set secret DISCORD_WEBHOOK_ALPHA_BACKUP to send notifications (optional).
#
# Separate repo backup: Set variable BACKUP_REPO (e.g. Krypton-Suite/Standard-Toolkit-Backup) and
# secret BACKUP_REPO_TOKEN (PAT with push access). Backups go into dated dirs: "Standard Toolkit Backup - YYYY-MM-DD".
# Optional: BACKUP_DIR_PREFIX (default "Standard Toolkit Backup"), BACKUP_BRANCH (default "main").

name: Alpha to Alpha-Backup Sync

on:
  schedule:
    # Run at midnight UTC daily
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Alpha Backup Sync Kill Switch Check
        id: kill_switch
        run: |
          disabled="${{ vars.ALPHA_BACKUP_SYNC_DISABLED }}"
          if [ "$disabled" = "true" ]; then
            echo "::warning:: Alpha Backup Sync workflow is currently DISABLED via kill switch (ALPHA_BACKUP_SYNC_DISABLED=true)"
            echo "To re-enable: Go to Repository Settings -> Secrets and Variables -> Actions -> Variables -> Set ALPHA_BACKUP_SYNC_DISABLED to 'false'."
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          else
            echo "Alpha Backup Sync kill switch check has passed, continuing..."
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: steps.kill_switch.outputs.enabled == 'true'
        uses: actions/checkout@v6
        with:
          ref: alpha
          fetch-depth: 0

      - name: Check for changes on alpha in last 24 hours
        if: steps.kill_switch.outputs.enabled == 'true'
        id: check_changes
        run: |
          yesterday=$(date -u -d '24 hours ago' '+%Y-%m-%d %H:%M:%S')
          commit_count=$(git rev-list --count --since="$yesterday" alpha 2>/dev/null || echo "0")
          echo "Commits on alpha in last 24 hours: $commit_count"
          if [ "${commit_count:-0}" -gt 0 ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure alpha-backup exists
        if: steps.kill_switch.outputs.enabled == 'true' && steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        id: ensure_backup
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            try {
              await github.rest.repos.getBranch({ owner, repo, branch: 'alpha-backup' });
              console.log('Branch alpha-backup already exists.');
              return 'exists';
            } catch (err) {
              if (err.status !== 404) throw err;
            }
            const { data: ref } = await github.rest.git.getRef({ owner, repo, ref: 'heads/alpha' });
            await github.rest.git.createRef({
              owner,
              repo,
              ref: 'refs/heads/alpha-backup',
              sha: ref.object.sha
            });
            console.log('Created branch alpha-backup from alpha.');
            return 'created';

      - name: Create PR from alpha to alpha-backup
        if: steps.kill_switch.outputs.enabled == 'true' && steps.check_changes.outputs.has_changes == 'true'
        id: create_pr
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            let result = { pr_created: false, pr_number: '', pr_url: '', pr_node_id: '' };
            const { data: compare } = await github.rest.repos.compareCommitsWithBasehead({
              owner,
              repo,
              basehead: 'alpha-backup...alpha'
            });
            if (compare.ahead_by === 0) {
              console.log('alpha-backup is already up to date with alpha; no PR needed.');
              return result;
            }
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:alpha`,
              base: 'alpha-backup'
            });
            if (prs.length > 0) {
              console.log('Open PR from alpha to alpha-backup already exists: #' + prs[0].number);
              result.pr_number = prs[0].number;
              result.pr_url = prs[0].html_url;
              result.pr_node_id = prs[0].node_id;
              return result;
            }
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: 'chore: sync alpha â†’ alpha-backup (automated)',
              head: 'alpha',
              base: 'alpha-backup',
              body: 'Automated PR: alpha has had commits in the last 24 hours. Merge to update alpha-backup.\n\n*Triggered by Alpha to Alpha-Backup Sync workflow.*'
            });
            console.log('Created PR #' + pr.number + ' from alpha to alpha-backup.');
            result.pr_created = true;
            result.pr_number = pr.number;
            result.pr_url = pr.html_url;
            result.pr_node_id = pr.node_id;
            return result;

      - name: Enable auto-merge on PR
        if: steps.kill_switch.outputs.enabled == 'true' && steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        env:
          PR_NODE_ID: ${{ fromJson(steps.create_pr.outputs.result).pr_node_id }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const nodeId = process.env.PR_NODE_ID;
            if (!nodeId) {
              console.log('No PR to enable auto-merge on.');
              return;
            }
            try {
              await github.graphql(`
                mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod) {
                  enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: $mergeMethod }) {
                    pullRequest { autoMergeRequest { enabledAt } }
                  }
                }
              `, { pullRequestId: nodeId, mergeMethod: 'MERGE' });
              console.log('Auto-merge enabled on PR.');
            } catch (err) {
              console.warn('Could not enable auto-merge (repo may not have Allow auto-merge enabled):', err.message);
            }

      - name: Push alpha to backup repository (dated directory)
        if: steps.kill_switch.outputs.enabled == 'true' && steps.check_changes.outputs.has_changes == 'true'
        id: backup_repo
        env:
          BACKUP_REPO: ${{ vars.BACKUP_REPO }}
          BACKUP_REPO_TOKEN: ${{ secrets.BACKUP_REPO_TOKEN }}
          BACKUP_DIR_PREFIX: ${{ vars.BACKUP_DIR_PREFIX }}
          BACKUP_BRANCH: ${{ vars.BACKUP_BRANCH }}
        run: |
          if [ -z "$BACKUP_REPO_TOKEN" ] || [ -z "$BACKUP_REPO" ]; then
            echo "BACKUP_REPO (variable) or BACKUP_REPO_TOKEN (secret) not set - skipping backup repo push"
            echo "pushed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          prefix="${BACKUP_DIR_PREFIX:-Standard Toolkit Backup}"
          branch="${BACKUP_BRANCH:-main}"
          today=$(date -u +%Y-%m-%d)
          dir_name="$prefix - $today"
          echo "dir_name=$dir_name" >> "$GITHUB_OUTPUT"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git clone --depth 1 "https://x-access-token:$BACKUP_REPO_TOKEN@github.com/$BACKUP_REPO.git" backup-repo
          cd backup-repo
          git checkout -b "$branch" 2>/dev/null || git checkout "$branch" 2>/dev/null || true
          mkdir -p "$dir_name"
          rsync -a --exclude='.git' ../. "$dir_name/"
          git add "$dir_name"
          git commit -m "chore: backup alpha to $dir_name (automated)"
          git push origin "$branch"
          echo "pushed=true" >> "$GITHUB_OUTPUT"
          echo "Pushed alpha to $BACKUP_REPO ($dir_name)"

      - name: Discord notification
        if: steps.kill_switch.outputs.enabled == 'true' && steps.check_changes.outputs.has_changes == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_ALPHA_BACKUP }}
          BRANCH_CREATED: ${{ steps.ensure_backup.outputs.result == 'created' }}
          PR_RESULT: ${{ steps.create_pr.outputs.result }}
          BACKUP_PUSHED: ${{ steps.backup_repo.outputs.pushed }}
          BACKUP_REPO: ${{ vars.BACKUP_REPO }}
          BACKUP_DIR: ${{ steps.backup_repo.outputs.dir_name }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK_ALPHA_BACKUP not set - skipping Discord notification"
            exit 0
          fi
          pr_link=""
          if [ -n "$PR_RESULT" ]; then
            pr_url=$(echo "$PR_RESULT" | jq -r '.pr_url // empty')
            pr_number=$(echo "$PR_RESULT" | jq -r '.pr_number // empty')
            if [ -n "$pr_url" ]; then
              pr_link="\nâ€¢ [PR #$pr_number]($pr_url)"
            fi
          fi
          backup_line=""
          if [ "$BACKUP_PUSHED" = "true" ] && [ -n "$BACKUP_REPO" ]; then
            backup_line="\nâ€¢ Pushed to backup repo: $BACKUP_REPO"
            if [ -n "$BACKUP_DIR" ]; then
              backup_line="$backup_line ($BACKUP_DIR)"
            fi
          fi
          branch_msg="alpha-backup branch already existed"
          if [ "$BRANCH_CREATED" = "true" ]; then
            branch_msg="alpha-backup branch was created (did not exist)"
          fi
          payload=$(jq -n \
            --arg branch "$branch_msg" \
            --arg pr_link "$pr_link" \
            --arg backup_line "$backup_line" \
            --arg run_url "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            '{
              embeds: [{
                title: "ðŸ“¦ Alpha â†’ Alpha-Backup Sync",
                description: ("Alpha had commits in the last 24 hours. Sync workflow ran.\n\nâ€¢ " + $branch + $pr_link + $backup_line + "\nâ€¢ [Workflow run](" + $run_url + ")"),
                color: 3447003,
                timestamp: (now | todate),
                footer: { text: "Alpha Backup Sync" }
              }]
            }')
          curl -sS -X POST "$DISCORD_WEBHOOK" -H "Content-Type: application/json" -d "$payload"
